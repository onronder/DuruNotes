# Production-Grade Dependency Review Workflow
# Automatically reviews dependency changes for security vulnerabilities
# Runs on pull requests to prevent supply chain attacks

name: 'Dependency Review & Security Audit'

on:
  pull_request:
    paths:
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - '.github/workflows/dependency-review.yml'

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dependency-review:
    name: Security Review - Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate review

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          # Fail on high or critical vulnerabilities
          fail-on-severity: moderate

          # Allow specific licenses (production-grade approach)
          allow-licenses: >
            MIT,
            Apache-2.0,
            BSD-2-Clause,
            BSD-3-Clause,
            ISC

          # Deny copyleft licenses (production requirement)
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0

          # Comment on PR with dependency changes
          comment-summary-in-pr: always

          # Additional security checks
          vulnerability-check: true
          license-check: true

          # GHSA (GitHub Advisory Database) check
          warn-only: false

  flutter-deps-audit:
    name: Flutter Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: 'stable'
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Check for outdated dependencies
        run: |
          echo "## Dependency Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check outdated packages
          flutter pub outdated --json > outdated.json || true

          if [ -s outdated.json ]; then
            echo "### Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat outdated.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ All dependencies are up to date!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify no wildcard dependencies
        run: |
          echo "## Wildcard Dependency Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for 'any' constraints (security risk)
          if grep -E ":\s*any\s*$" pubspec.yaml; then
            echo "❌ **ERROR**: Found wildcard dependencies!" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -E ":\s*any\s*$" pubspec.yaml >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "Wildcard dependencies compromise supply chain security." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ No wildcard dependencies found - all pinned!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for known vulnerabilities
        continue-on-error: true
        run: |
          echo "## Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Flutter doesn't have built-in audit like npm, but we can check deps
          # In production, integrate with tools like Snyk or Dependabot
          flutter pub deps --json > deps.json

          echo "✅ Dependency tree analyzed" >> $GITHUB_STEP_SUMMARY
          echo "For detailed vulnerability scanning, integrate Snyk or Dependabot" >> $GITHUB_STEP_SUMMARY

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-reports
          path: |
            outdated.json
            deps.json
          retention-days: 30

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: 'stable'
          cache: true

      - name: Check licenses
        run: |
          flutter pub get

          echo "## License Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract licenses from dependencies
          flutter pub deps --json | jq -r '.packages[] | "\(.name): \(.license // "UNKNOWN")"' > licenses.txt || true

          # Check for problematic licenses
          if grep -iE "GPL|AGPL|SSPL" licenses.txt; then
            echo "⚠️  **WARNING**: Found copyleft licenses" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -iE "GPL|AGPL|SSPL" licenses.txt >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No problematic licenses detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-report
          path: licenses.txt
          retention-days: 90

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-review, flutter-deps-audit, license-compliance]
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "# 🔒 Dependency Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependency security checks completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Checks Performed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ GitHub Dependency Review" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Wildcard Dependency Detection" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Outdated Package Check" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ License Compliance Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the individual job logs for detailed information." >> $GITHUB_STEP_SUMMARY
